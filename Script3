import { BaseDTO } from "./baseModels";
import * as Yup from "yup";
import dayjs from "dayjs";
import customParseFormat from "dayjs/plugin/customParseFormat";
 
dayjs.extend(customParseFormat);

//Data model
export interface NbfcLoanDetails extends BaseDTO {
  customerAppliedAmount?: number;
  nbfcCustomerApplicationDate?: number;
  customerRequestedTenure?: number;
  nbfcLoanAmount?: number;
  nbfcSanctionDate?: Date;
  nbfcTenure?: number;
  purpose?: string;
  cgtmse?: string;
  nbfcRateType?: string; //UI
  nbfcMclrReferenceRate?: number; //UI
  nbfcSpread?: number; //UI
  nbfcRoi?: number;
  blendedRate?: number;
  effectiveServiceFee?: number;
  serviceFeePayableToNBFC?: number;
  sidbiRate?: number;
  nbfcRate?: number;
  mclrReferenceRate?: number;
  sidbiRateVal?: number;
  actualSidbiSharePercentage?: number;
}

//Validation Schema for the model
export const nbfcLoanDetailsSchema = (nbfcRate: number, sidbiRate: number, actualSidbiSharePercentage: number | undefined) => Yup.object().shape({
  customerAppliedAmount: Yup.number()
    .typeError("Please enter a valid number")
    .required("Please enter a valid number"),
  nbfcCustomerApplicationDate: Yup.string()
    .nullable()  // This allows null values (so the field can be empty).
    .notRequired()  // Makes it optional, so validation is not triggered if the field is empty.
    .test(
      'valid-date',
      'Please enter a valid date in DD/MM/YYYY format',
      (value) => {
        if (value) {
          const parsedDate = dayjs(value);
          if (parsedDate.isValid()) {
            value = parsedDate.format('YYYY-MM-DD'); // Extract only the date
          }
          // Check if the date is valid in the required format
          return dayjs(value, 'YYYY-MM-DD', true).isValid();
        }
        return true; // Return true if the field is empty, so validation passes
      }
    )
    .test(
      'not-future-date',
      'Date cannot be in the future',
      (value) => {
        if (value) {
          // Ensure the date is not in the past or in the future
          return !(dayjs(value).isSame(dayjs(), 'day') || dayjs(value).isAfter(dayjs(), 'day'));
        }
        return true; // Return true if the field is empty, so validation passes
      }
    )
    ,
  customerRequestedTenure: Yup.number()
    .typeError("Please enter a valid number")
    .required("Please enter a valid number"),
  nbfcLoanAmount: Yup.number()
    .typeError("Please enter a valid number")
    .required("Please enter a valid number"),
  nbfcSanctionDate: Yup.string()
    .nullable()
    .notRequired()
    .transform((value) => {
      if (!value) return value;
      const d = dayjs(value, "DD/MM/YYYY", true);
      return d.isValid() ? d.format("YYYY-MM-DD") : value; // stored as YYYY-MM-DD
    })
    .test(
      "valid-date",
      "Please enter a valid date in DD/MM/YYYY format",
      (value) => {
        if (!value) return true;
        return dayjs(value, ["YYYY-MM-DD", "DD/MM/YYYY"], true).isValid();
      }
    )
    .test(
      "sanction-after-disbursal",
      "NBFC Sanction Date must be greater than or equal to Customer Application Date",
      function (value) {
        if (!value) return true;
        const { nbfcCustomerApplicationDate } = this.parent;
        if (!nbfcCustomerApplicationDate) return true;
  
          const sanction = dayjs(value, ["YYYY-MM-DD", "DD/MM/YYYY"], true);
          const disbursal = dayjs(nbfcCustomerApplicationDate, ["YYYY-MM-DD", "DD/MM/YYYY"], true);
  
          if (!sanction.isValid() || !disbursal.isValid()) return true;
  
          return (
            sanction.isSame(disbursal, "day") ||
            sanction.isAfter(disbursal, "day")
          );
        }
      ),
  nbfcTenure: Yup.number()
    .typeError("Please enter a valid number")
    .required("Please enter a valid number")
    .test(
      'is-less-than-or-equal-to-nbfcTenure',
      'Assured Tenure should not be greater than Total Tenure (In Months) of the Loan',
      function (value) {
        const { customerRequestedTenure } = this.parent; // Access `nbfcTenure` from the parent object
        return value !== undefined && value <= customerRequestedTenure; // Ensure `value` is defined and validate
      }
    ),
  purpose: Yup.string()
    .notRequired()
    .typeError("Please select from the drop down"),
  cgtmse: Yup.string()
    .required("Please select a value from drop-down list"),
  nbfcRateType: Yup.string()
  .required("Please select a value from drop-down list"),
  // nbfcRate: Yup.string().required("NBFC Rate is required"),
  nbfcRate: Yup.number()
  .notRequired()
  // .test(
  //   "nbfc-greater-than-sidbi",
  //   "NBFC Rate must be greater than SIDBI Rate",
  //   (value) => {      
  //     if (isNaN(nbfcRate) || isNaN(sidbiRate)) return true;
  //     return Number(nbfcRate) > sidbiRate;
  //   }
  // )
  ,
  nbfcSpread: Yup.string().required("NBFC Spread is required"),
  nbfcMclrReferenceRate: Yup.number().required("MCLR Ref Rate is mandatory."),
  // blendedRate: Yup.string().test(
  //   "blended-rate-check",
  //   function (value) {
  //     // Use the arguments passed to the factory function directly
  //     const sRate = Number(sidbiRate);
  //     const nRate = Number(nbfcRate);
  //     const sharePerc = Number(actualSidbiSharePercentage);

  //     // Skip validation if data is missing or invalid
  //     if (isNaN(sRate) || isNaN(nRate) || isNaN(sharePerc)) {
  //       return true;
  //     }

  //     // 1. Recompute blended rate
  //     const computedBlendedRate =
  //       (sRate * sharePerc) / 100 + 
  //       (nRate * (1 - sharePerc / 100));

  //     // 2. Determine threshold logic
  //     const isHighShare = sharePerc > 80;
  //     const maxAllowed = isHighShare ? sRate + 0.5 : sRate + 1;

  //     // 3. Validation Check
  //     if (computedBlendedRate > maxAllowed) {
  //       return this.createError({
  //         message: isHighShare
  //           ? "Blended Rate Test cannot exceed SIDBI Rate + 0.5%"
  //           : "Blended Rate Test cannot exceed SIDBI Rate + 1%",
  //       });
  //     }

  //     return true;
  //   }
  // ),
});

//Default values
export const defaultNbfcLoanDetails = {
  customerAppliedAmount: undefined,
  nbfcCustomerApplicationDate: undefined,
  customerRequestedTenure: undefined,
  nbfcLoanAmount: undefined,
  nbfcSanctionDate: undefined,
  nbfcTenure: undefined,
  purpose: undefined,
  cgtmse: undefined,
  nbfcRateType: undefined,
  nbfcMclrReferenceRate: undefined,
  nbfcSpread: undefined,
  nbfcRoi: undefined,
  blendedRate: undefined,
  effectiveServiceFee: undefined,
  serviceFeePayableToNBFC: undefined,
  sidbiRate: undefined,
  nbfcRate: undefined,
  mclrReferenceRate: undefined,
  sidbiRateVal: undefined,
  actualSidbiSharePercentage: undefined,
};

import Grid from "@mui/material/Grid";
import { useGetConfigQuery, useGetLeadQuery, useUpdateLeadMutation } from "../../slices/leadSlice";
import EntityForm from "../../Components/Framework/EntityForm";
import { TextBoxField } from "../../Components/Framework/TextBoxField";
import { useState, useEffect, useMemo, useImperativeHandle } from "react";
import Typography from "@mui/material/Typography";
import { ErrorMessage } from "../../Components/Framework/ErrorMessage";
import LinearProgress from "@material-ui/core/LinearProgress";
import * as Yup from "yup";
import { useFormikContext } from "formik";
import {
  FormSubmit,
  SubmitableForm,
} from "../../Components/Framework/FormSubmit";
import { DatePickerField } from "../../Components/Framework/DatePickerField";
import React from "react";
import { useAppSelector } from "../../app/hooks";
import {
  defaultLoanDetails,
  loanDetailsSchema,
} from "../../models/loanDetails";
import {
  defaultNbfcLoanDetails,
  nbfcLoanDetailsSchema,
} from "../../models/nbfcLoanDetails";
import Section from "../../Components/Framework/Section";
// import { DropDownField } from "../../Components/Framework/DropDownField";
import { TextBoxFieldAmountStartAdornment } from "../../Components/Framework/TextBoxFieldAmountStartAdornment";
import { TextBoxFieldAmountStartAdornmentWithDecimal } from "../../Components/Framework/TextBoxFieldAmountStartAdornmentWithDecimal";
import { TextBoxFieldPercentageEndAdornment } from "../../Components/Framework/TextBoxFieldPercentageEndAdornment";
import { AutocompleteField } from "../../Components/Framework/AutocompleteField";
import { DropDownFieldYesNo } from "../../Components/Framework/DropDownFieldYesNo";
import { TextField } from "@material-ui/core";
import { DisplayOnlyTextField } from "../../Components/Framework/DisplayOnlyTextField";
import { SidbiDisbursementDate, SidbiLoanAmount, SidbiLoanAmountFormError, SidbiShare } from "./SidbiLoanAsk";
import { skipToken } from "@reduxjs/toolkit/dist/query";
import { sidbiShareSchema } from "../../models/sidbiShare";
import SaveColorButton from "../../Components/Framework/ColorButton";
import { formatNumberWithCommasAndZeroAllowed } from "../../Components/utilities";
import { DropDownFieldInlineDomain } from "../../Components/Framework/DropDownFieldInlineDomain";
import { ReadOnlyTextBox } from "../../Components/Framework/ReadOnlyTextBox";
import OriginalSanctionDetails from "./OriginalSanctionDetails";
import { KeyValuePair } from "../../Components/Framework/KeyValuePair";
import FormControl from "@mui/material/FormControl";
import FormHelperText from "@mui/material/FormHelperText";
import ErrorMesasage from "../../Components/ErrorMessage";

const formatNonDigitCharacter = (num: string): string => {
  if (num == null) return ""; // handle undefined or null safely
  const str = String(num); // ensure it's a string
  // Allow digits and a single decimal point
  let formattedNum = str.replace(/[^0-9.]/g, "");
 
  // Ensure there's only one decimal point
  const parts = formattedNum.split(".");
  if (parts.length > 2) {
    formattedNum = `${parts[0]}.${parts[1]}`;
  }
 
  // Cap the value if it exceeds 100, but only after a full number is entered
  if (parseFloat(formattedNum) > 100) {
    return "100";
  }
 
  // Limit the decimal part to two digits
  if (parts[1]) {
    formattedNum = `${parts[0]}.${parts[1].substring(0, 2)}`;
  }
 
  return formattedNum;
};

const LoanDetails = React.forwardRef<SubmitableForm, {}>((props, ref) => {
  const { id: leadId } = useAppSelector((state) => state.leadStore);
  const { values, submitCount, touched } = useFormikContext<KeyValuePair>() || {};
    
  const [error, setError] = useState<string|undefined>();
  const [isError, setIsError] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const { data } = useGetLeadQuery(Number(leadId) || skipToken)
  const [isProjectLoanYes, setIsProjectLoanYes] = useState(false);
  const blendedRoiOnSanction = data?.loanDetails?.blendedRoiOnSanction;
  const [blendedRoiSubmit, setBlendedRoiSubmit] = useState(data?.loanDetails?.blendedRoi ?? 0);
  // const  = data?.loanDetails?.blendedRoi;
  const [nbfcAssessedAmount , setNbfcAssessedAmount ] = React.useState(data?.nbfcLoanDetails?.nbfcLoanAmount);
  
  const [isInterestFixationPossibleSanction, setIsInterestFixationPossibleSanction] = useState((data?.leadStatus === "SANCTIONED") && data?.sidbiStatus === "WITH_NBFC");
  const [isInterestFixationPossibleDisbursed, setIsInterestFixationPossibleDisbursed] = useState(data?.leadStatus === "DISBURSED");
 
  const handleProjectLoanChange = (event: any) => {
    setIsProjectLoanYes(event.target.value === "y"); // Check if 'Yes' is selected
  };

  const {data : config} = useGetConfigQuery(Number(leadId) || skipToken);

  const [nbfcRoi, setNbfcRoi] = useState<number | null>(data?.nbfcLoanDetails?.nbfcRoi ?? null);
  const [sidbiRoiToCustomer, setSidbiRoiToCustomer] = useState<number | null>(data?.loanDetails?.sidbiRate ?? null);
  // alert('nbfcRoi = ' + nbfcRoi + ' sidbiRoiToCustomer = ' + sidbiRoiToCustomer);
  // const [nbfcRoi, setNbfcRoi] = useState<number | null>(null);
  // const [sidbiRoiToCustomer, setSidbiRoiToCustomer] = useState<number | null>(null);
  const [effectiveRate, setEffectiveRate] = useState<number | null>(null);
  const [effectiveDiff, setEffectiveDiff] = useState<number | string>("");
  // const [maxSidbiShare, setMaxSidbiShare] = useState(0);

  const formToSubmit = React.useRef<SubmitableForm>(null);

  const setErrorHook = (errorLocal: any) => {
    console.log("Set error hook", errorLocal);
    if(errorLocal) {
      if(errorLocal !== "") {
        setIsError(true) 
        setError(errorLocal)
      } else {
        setIsError(false)
        setError(undefined)
      }
    }
  }

   useEffect(()=>{
     console.log("Original 2 here Sanction Details")
    },[])

  useEffect(() => {
    console.log("Form error: ", error)
  }, [error, isError])

  useImperativeHandle(ref, () => ({

    clearErrors() {
      setError("");
    },

    async submit() {
      setError("")
      if (formToSubmit.current) return formToSubmit.current?.submit();
      else return false;
    },

    isDirty() {
      if (formToSubmit.current) {
        setError("")
        return formToSubmit.current?.isDirty()
      } else {
        return false;
      }
    },
    
    async isValid(finalSubmit?: boolean) {
      console.log("Loan details is valid called " + error + " :: ");
      if(!formToSubmit.current) {
        console.error("formToSubmit.current is null");
        return false;
      }
      const isValid=await formToSubmit.current.isValid();
      if(!isValid) return false;
      return true;
    }

  }));

  const sidbiMclrRate = (data?.loanDetails?.benchMarkRate);
  const sidbiSpread = (data?.loanDetails?.spread);
  const fldgSpreadPercentage = (data?.loanDetails?.fldgSpreadPercentage);
  const sidbiHurdleRate = (
    ((sidbiMclrRate || 0) + 
    (sidbiSpread || 0) -
    (fldgSpreadPercentage || 0))
  );

  const [serviceFeePayableToNBFC, setServiceFeePayableToNBFC] = useState(data?.loanDetails?.serviceFeePayableToNbfc);
  const handleChangeServiceFeePayableToNBFC = (event: any) => {
    setServiceFeePayableToNBFC(parseFloat(event.target.value));
  };

  const effectiveServiceFee = Number((
    (serviceFeePayableToNBFC || 0) + 
    (fldgSpreadPercentage || 0)
  ).toFixed(2));

  const sidbiRate = Number((
    (sidbiHurdleRate || 0) + 
    (effectiveServiceFee || 0)).toFixed(2));

  const [nbfcMclrRefRate, setNbfcMclrRefRate] = useState(data?.nbfcLoanDetails?.nbfcMclrReferenceRate);
  const handleChangeNbfcMclrRefRate = (event: any) => {
    setNbfcMclrRefRate(parseFloat(event.target.value));
  };

  const [nbfcSpread, setNbfcSpread] = useState(data?.nbfcLoanDetails?.nbfcSpread);
  const handleChangeNbfcSpread = (event: any) => {
    setNbfcSpread(parseFloat(event.target.value));
  };

  const nbfcRate = Number((
    (nbfcMclrRefRate || 0) + 
    (nbfcSpread || 0)
  ).toFixed(2))

  const [actualSidbiSharePercentage, setActualSidbiSharePercentage] = useState(data?.loanDetails?.sidbiShareAge || config?.sidbiShare);
  const maxSidbiShareValue = (config?.sidbiShare ?? 0) * 100;
  const minSidbiShareValue=50;
  const handleChangeActualSidbiSharePercentage = (event: any) => {
    setActualSidbiSharePercentage(parseFloat(event.target.value));
  };

  const blendedRate = (
    (sidbiRate * (actualSidbiSharePercentage || 0) / 100) +
    (nbfcRate * (1 - ((actualSidbiSharePercentage || 0) / 100)))
  )
  
  return leadId ? ( 
    <EntityForm
      id={leadId || 0}
      defaultItem={{
        loanDetails: defaultLoanDetails,
        nbfcLoanDetails: defaultNbfcLoanDetails
      }}
      itemSchema={Yup.object().shape({
        loanDetails: loanDetailsSchema(maxSidbiShareValue,minSidbiShareValue), 
        nbfcLoanDetails: nbfcLoanDetailsSchema(nbfcRate, sidbiRate, actualSidbiSharePercentage),
      })}
      useUpdateItemMutation={useUpdateLeadMutation}
      useGetItemQuery={useGetLeadQuery}
      setError={setErrorHook}
      setIsLoading={setIsLoading}
    >
      <Grid
        container
        style={{
          backgroundColor: error && "#FFD1DC",
          paddingBottom: 0,
          paddingLeft: "16px",
          paddingRight: "8px",
        }}
        spacing={2}
      >
        <Grid item xs={12} lg={12}>
          {isLoading && <LinearProgress color="secondary" />}
        </Grid>

        {isInterestFixationPossibleSanction && <>
        <Section>
          <Grid
            container
            spacing={4}
            padding={4}
          >
            <Grid item xs="auto">
              <Typography
                variant="h6"
                gutterBottom
                style={{ marginBottom: "0px", fontWeight: "600" }}
              >
                Original Sanction Details
              </Typography>
            </Grid>
            <Grid item xs={12}>
              <OriginalSanctionDetails />
            </Grid>
          </Grid>
        </Section>
            </>
        }

        {error && <Grid item xs={12} lg={12}>
          <ErrorMesasage error={error} isError={error !== undefined && error !== ""} />
        </Grid>}
        <Section sx={{ marginTop: "24px", width: '100%' }}>
          <Grid container spacing={2} padding={4}>
            <Grid item xs={12} lg={12}>
              <Typography
                variant="h6"
                gutterBottom
                style={{ marginBottom: "0px", fontWeight: "600" }}
              >
                NBFC Loan Details
              </Typography>
            </Grid>
            <Grid item xs={12} lg={4}>
              <TextBoxFieldAmountStartAdornmentWithDecimal
                label={
                  <>
                    Customer Applied Amount<span style={{ color: 'red' }}> *</span>
                  </>
                }
                name={"nbfcLoanDetails.customerAppliedAmount"}
              />
            </Grid>
            <Grid item xs={12} lg={4}>
                <DatePickerField
                  label={
                    <>
                    Customer Application Date
                    </>
                  }
                  name="nbfcLoanDetails.nbfcCustomerApplicationDate"
                  allowPast={true}
                />
              </Grid>
              <Grid item xs={12} lg={4}>
              <TextBoxField
                label={
                  <>
                    Requested Tenure (Months)<span style={{ color: 'red' }}> *</span>
                  </>
                }
                name="nbfcLoanDetails.customerRequestedTenure"
                type="number"
                maxLength={3}
              />
            </Grid>
            <Grid item xs={12} lg={4}>
              <TextBoxFieldAmountStartAdornmentWithDecimal
                label={
                  <>
                    NBFC assessed amount (in Rs)<span style={{ color: 'red' }}> *</span>
                  </>
                }
                name={"nbfcLoanDetails.nbfcLoanAmount"}
                onChange={(value: any) => {
                  // Extract the raw string value
                  let val = typeof value === 'object' ? value?.target?.value || value?.value : value;
                
                  // Remove all commas if val is a string
                  if (typeof val === 'string') {
                    val = val.replace(/,/g, ''); 
                  }
                
                  setNbfcAssessedAmount(val);
                }}
              />
            </Grid>
            <Grid item xs={12} lg={4}>
              <DatePickerField
                label={
                  <>
                  NBFC Sanction Date
                  </>
                }
                name="nbfcLoanDetails.nbfcSanctionDate"
                allowPast={true}
              />
            </Grid>
            <Grid item xs={12} lg={4}>
              <TextBoxField
                label={
                  <>
                    NBFC assessed Tenure (months)
                    <span
                      style={{ color: "red" }}
                    >
                      {" "}
                      *
                    </span>
                  </>
                }
                name="nbfcLoanDetails.nbfcTenure"
                type="number"
                maxLength={3}
              />
            </Grid>
            <Grid item xs={12} lg={4}>
              <AutocompleteField
                label={"Purpose"}
                name={"nbfcLoanDetails.purpose"}
                domain={"m_purpose_of_loan"}
              />
            </Grid>
            <Grid item xs={12} lg={4}>
              {/* <DropDownFieldYesNo
                label="CGTMSE"
                name={"nbfcLoanDetails.cgtmse"}
              /> */}
              <AutocompleteField
                label={
                  <>
                    CGTMSE<span style={{ color: 'red' }}> *</span>
                  </>
                }
                name={"nbfcLoanDetails.cgtmse"}
                domain={"m_cgstme"}
              />
            </Grid>
            {/* {data?.productName === 'secured' && (
              <>
                <Grid item xs={12} lg={4}>
                  <DropDownFieldYesNo
                    label={
                      <>
                        Project Loan
                      </>
                    }
                    name={"nbfcLoanDetails.projectloan"}
                    onChange={handleProjectLoanChange}
                    // onChange={(event: any) => {
                    //   console.log(event.target.value);
                    //   setIsProjectLoanYes(event.target.value === 'Yes');
                    // }}
                  />
                </Grid>
                {isProjectLoanYes && (
                  <Grid item xs={12} lg={4}>
                    <DatePickerField label="DCCO" name={"nbfcLoanDetails.dcco"} />
                  </Grid>
                )}
              </>
            )} */}
          </Grid>
          {isLoading && (
            <Grid container spacing={0} padding={0}>
              <Grid item xs={12} lg={12}>
                <LinearProgress color="secondary" />
              </Grid>
            </Grid>
          )}
        </Section>

        <Section sx={{ marginTop: "24px", width: '100%' }}>
          {isLoading && (
            <Grid container spacing={0} padding={0}>
              <Grid item xs={12} lg={12}>
                <LinearProgress color="secondary" />
              </Grid>
            </Grid>
          )}
          <Grid container spacing={2} padding={4}>
            <Grid item xs={12} lg={12}>
              <Typography
                variant="h6"
                gutterBottom
                style={{ marginBottom: "0px", fontWeight: "600" }}
              >
                Loan Ask
              </Typography>
            </Grid>
            {/* <Grid item xs={12} lg={12}>
              <ErrorMessage status={error} />
            </Grid> */}
            <Grid item xs={12} lg={4}>
              <TextBoxFieldPercentageEndAdornment
                label={
                  <>
                  Max SIDBI Share Percentage
                  </>
                }
                css={"#F8F8F8"}
                name={"dummy"}
                disabled
                valueChanged={((config?.sidbiShare ?? 0) * 100)}
              />
            </Grid>
            <Grid item xs={12} lg={4}>
              <TextBoxFieldPercentageEndAdornment
                label={
                  <>
                  Actual SIDBI Share Percentage<span style={{ color: 'red' }}> *</span>
                  </>
                }
                name={"loanDetails.sidbiShareAge"}
                onChange={handleChangeActualSidbiSharePercentage}
                // valueChanged={(actualSidbiSharePercentage || 0) }
              />
            </Grid>
            <Grid item xs={12} lg={4}>
              <SidbiLoanAmount nbfcLoanAmount={nbfcAssessedAmount} sidbiShare={(actualSidbiSharePercentage??0)/100} />
            </Grid>
            <Grid item xs={12} lg={4}>
                <TextBoxField
                  label={
                      <>
                      NBFC LAN
                      {isInterestFixationPossibleDisbursed && (
                        <span style={{ color: "red" }}> *</span>
                      )}
                      </>
                  }
                  name={"loanDetails.nbfcLoanAccountNumber"}
                />
                
                <Typography
                  variant="body1"
                  gutterBottom
                  style={{
                    marginBottom: "0px",
                    fontWeight: "400",
                    color: "#A9A9A9",
                  }}
                >
                  Note: Mandatory at the time of disbursement
                </Typography>
            </Grid>
          </Grid>
        </Section>

        <Section sx={{ marginTop: "24px", width: '100%' }}>
          {isLoading && (
            <Grid container spacing={0} padding={0}>
              <Grid item xs={12} lg={12}>
                <LinearProgress color="secondary" />
              </Grid>
            </Grid>
          )}
          <Grid container spacing={2} padding={4}>
            <Grid item xs={12} lg={12}>
              <Typography
                variant="h6"
                gutterBottom
                style={{ marginBottom: "0px", fontWeight: "600" }}
              >
                Interest Fixation
              </Typography>
            </Grid>
            {/* {error && <Grid item xs={12} lg={12}>
              <ErrorMessage status={error} />
            </Grid>} */}
            <Grid item xs={12} lg={12}>
              <Typography
                variant="body1"
                gutterBottom
                style={{ marginBottom: "0px", fontWeight: "600" }}
              >
                Originating RE Portion
              </Typography>
            </Grid>
              
            <Grid item xs={12} lg={12}>
              <Grid container spacing={2} padding={0}>
                <Grid item xs={12} lg={4}>
                  <DropDownFieldInlineDomain
                    label={
                      <>
                        RE Rate Type<span style={{ color: 'red' }}> *</span>
                      </>
                    }
                    name="nbfcLoanDetails.nbfcRateType"
                    domain={["Fixed", "Floating"]}  
                  />
                </Grid>
                {/* <Grid item xs={12} lg={4}>
                  <DropDownFieldYesNo
                    label={
                      <>FLDG Applicable<span style={{ color: 'red' }}> *</span></>
                    }
                    name={"loanDetails.fldgApplicable"}
                    onChange={handleChangeFldgApplicable}
                    // disabled
                    // css={"#F8F8F8"}
                  />
                </Grid> */}
              </Grid>
            </Grid>
              
            <Grid item xs={12} lg={12}>
              <Grid container spacing={2} padding={0} alignItems={"center"}>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        RE Reference Rate<span style={{ color: 'red' }}> *</span>
                      </>
                    }
                    name={"nbfcLoanDetails.nbfcMclrReferenceRate"}
                    onChange={handleChangeNbfcMclrRefRate}
                    // valueChanged={nbfcMclrRefRate}
                  />
                </Grid>
                <Grid item xs="auto">+</Grid>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        RE Spread<span style={{ color: 'red' }}> *</span>
                      </>
                    }
                    name={"nbfcLoanDetails.nbfcSpread"}
                    onChange={handleChangeNbfcSpread}
                    allowNegativeValue={true}
                    // valueChanged={nbfcSpread}
                  />
                </Grid>
                <Grid item xs="auto">=</Grid>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                      RE Rate
                      </>
                    }
                    name={"nbfcLoanDetails.nbfcRate"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={nbfcRate}
                  />
                </Grid>
              </Grid>
            </Grid>
              
              <Grid item xs={12} lg={12}>
                <Grid container spacing={2} padding={0}>
                <Grid item xs={12} lg={4}>
                    <TextBoxFieldPercentageEndAdornment
                      label={
                        <>
                          Service Fee Payable to RE<span style={{ color: 'red' }}> *</span>
                        </>
                      }
                      name={"loanDetails.serviceFeePayableToNbfc"}
                      onChange={handleChangeServiceFeePayableToNBFC}
                    />
                  </Grid>
                </Grid>
              </Grid>

            <Grid item xs={12} lg={12}>
              <Typography
                variant="body1"
                gutterBottom
                style={{ marginBottom: "0px", fontWeight: "600" }}
              >
                SIDBI Portion
              </Typography>
            </Grid>
            <Grid item xs={12} lg={12}>
              <Grid container spacing={2} padding={0}>
                <Grid item xs={12} lg={4}>
                  <ReadOnlyTextBox
                    label="SIDBI Hurdle Type"
                  value={data?.loanDetails?.rateType === 'L'? 'Floating' : data?.loanDetails?.rateType === 'F'? 'Fixed' : ''}
                  />
                </Grid>
              </Grid>
            </Grid>

            <Grid item xs={12} lg={12}>
              <Grid container spacing={2} padding={0} alignItems={"center"}>
                <Grid item xs={3}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        Service Fee Payable to RE<span style={{ color: 'red' }}> *</span>
                      </>
                    }
                    name={"loanDetails.serviceFeePayableToNbfc"}
                    disabled
                    css={"#F8F8F8"}
                    onChange={handleChangeServiceFeePayableToNBFC}
                  />
                </Grid>
                {(fldgSpreadPercentage && fldgSpreadPercentage > 0)? <><Grid item xs="auto">+</Grid>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                      FLDG Spread Percentage<span style={{ color: 'red' }}> *</span>
                      </>
                    }
                    name={"loanDetails.fldgSpreadPercentage"}
                    disabled
                    css={"#F8F8F8"}
                  />
                </Grid></> : <></>}
                <Grid item xs="auto">=</Grid>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                      Effective Service Fee
                      </>
                    }
                    name={"loanDetails.effectiveServiceFee"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={effectiveServiceFee}
                  />
                </Grid>
              </Grid>
            </Grid>
            
            <Grid item xs={12} lg={12}>
              <Grid container spacing={2} padding={0} alignItems={"center"}>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        MCLR Rate
                      </>
                    }
                    name={"loanDetails.benchMarkRate"}
                    disabled
                    css={"#F8F8F8"}
                  />
                </Grid>
                <Grid item xs="auto">+</Grid>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        Spread (%)
                      </>
                    }
                    name={"loanDetails.spread"}
                    disabled
                    css={"#F8F8F8"}
                  />
                </Grid>
                {(fldgSpreadPercentage && fldgSpreadPercentage > 0)? <><Grid item xs="auto">-</Grid>
                <Grid item xs={2.71}>
                   <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                      FLDG Spread Percentage
                      </>
                    }
                    name={"loanDetails.fldgSpreadPercentage"}
                    disabled
                    css={"#F8F8F8"}
                  />
                </Grid></> : <></>}
                <Grid item xs="auto">=</Grid>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                      SIDBIâ€™s Hurdle Rate
                      </>
                    }
                    name={"loanDetails.sidbiHurdleRate"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={Number(sidbiHurdleRate.toFixed(2))}
                  />
                </Grid>
              </Grid>
            </Grid>

            <Grid item xs={12} lg={12}>
              <Grid container spacing={2} padding={0} alignItems={"center"}>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        SIDBI Hurdle Rate
                      </>
                    }
                    name={"loanDetails.sidbiRate"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={Number(sidbiHurdleRate.toFixed(2))}
                  />
                </Grid>
                <Grid item xs="auto">+</Grid>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        Effective Service Fee
                      </>
                    }
                    name={"loanDetails.effectiveServiceFee"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={effectiveServiceFee}
                  />
                </Grid>
                <Grid item xs="auto">=</Grid>
                <Grid item xs={2.71}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                      SIDBI Rate
                      </>
                    }
                    name={"nbfcLoanDetails.sidbiRate"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={Number(sidbiRate.toFixed(2))}
                  />
                </Grid>
              </Grid>
            </Grid>
            
            <Grid item xs={12} lg={12}>
              <Typography
                variant="body1"
                gutterBottom
                style={{ marginBottom: "0px", fontWeight: "600" }}
              >
                Blended
              </Typography>
            </Grid>
            
            <Grid item xs={12} lg={12}>
              <Grid container spacing={0.5} padding={0} alignItems={"center"}>
                <Grid item xs="auto">(</Grid>
                <Grid item xs={2.03}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        SIDBI Rate
                      </>
                    }
                    name={"nbfcLoanDetails.sidbiRateVal"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={Number(sidbiRate.toFixed(2))}
                  />
                </Grid>
                <Grid item xs="auto">*</Grid>
                <Grid item xs={2.1}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        Actual SIDBI Share %
                      </>
                    }
                    name={"nbfcLoanDetails.actualSidbiSharePercentage"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={(actualSidbiSharePercentage || 0)}
                  />
                </Grid>
                <Grid item xs="auto">)</Grid>
                <Grid item xs="auto">+</Grid>
                <Grid item xs="auto">(</Grid>
                <Grid item xs={2.03}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        NBFC Rate
                      </>
                    }
                    name={"nbfcLoanDetails.nbfcRate"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={nbfcRate}
                  />
                </Grid>
                <Grid item xs="auto">*</Grid>
                <Grid item xs={2.4}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                        NBFC Share %
                      </>
                    }
                    name={"nbfcLoanDetails.actualSidbiSharePercentage"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={(100 - (actualSidbiSharePercentage || 0))}
                  />
                </Grid>
                <Grid item xs="auto">)</Grid>
                <Grid item xs="auto">=</Grid>
                <Grid item xs={2.03}>
                  <TextBoxFieldPercentageEndAdornment
                    label={
                      <>
                      Blended Rate
                      </>
                    }
                    name={"nbfcLoanDetails.blendedRate"}
                    disabled
                    css={"#F8F8F8"}
                    valueChanged={Number(blendedRate.toFixed(2))}
                  />
                </Grid>
              </Grid>
            </Grid>
          </Grid>
        </Section>
      </Grid>
      <FormSubmit ref={formToSubmit} />
    </EntityForm>
  ) : (
    <>Loading...</>
  );
});

export default LoanDetails;

NBFC assessed amount should not be greater than customer applied amount
Service fee payable to RE - null and zero should not be allowed these two ponints we do that and one more thing don't remove comment alignmnet etc and give me complete and proper code 
